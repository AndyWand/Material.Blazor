@inherits MdcComponentBase

@using System.Threading.Tasks
 
@inject IJSRuntime jsRuntime


<div @ref="elementReference" class="mdc-tab-bar bmdc-tab-bar" role="tablist">
    <div class="mdc-tab-scroller">
        <div class="mdc-tab-scroller__scroll-area">
            <div class="mdc-tab-scroller__scroll-content">
                @{ int i = 0; }
                @foreach (var content in tabContents)
                {
                    int index = i++;
                    bool selected = (index == initialTabIndex);
                    string buttonActive = selected ?  "mdc-tab--active" : "";
                    string indicatorActive = selected ? "mdc-tab-indicator--active" : "";

                    <button class="mdc-tab @stackClass @buttonActive" role="tab" aria-selected="@selected" tabindex="-1" @onclick="(_ => OnTabClickAsync(content, index))">
                        <span class="mdc-tab__content">
                            @if (!(content.TabIcon is null))
                            {
                                <span class="mdc-tab__icon material-icons" aria-hidden="true">@content.TabIcon</span>
                            }
                            
                            <span class="mdc-tab__text-label">@content.TabText</span>
                        </span>
                        <span class="mdc-tab-indicator @indicatorActive">
                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                        </span>
                        <span class="mdc-tab__ripple"></span>
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<CascadingValue Value="this">
    @ChildContent
</CascadingValue>


@code {
    [CascadingParameter]
    private MdcCascadingDefaults MdcCascadingDefaults { get; set; } = new MdcCascadingDefaults();
    private MdcCascadingDefaults myCascadingDefaults => (MdcCascadingDefaults is null) ? new MdcCascadingDefaults() : MdcCascadingDefaults;

    [Parameter] public int TabIndex { get; set; }
    [Parameter] public bool StackIcons { get; set; }
    [Parameter] public RenderFragment ChildContent { get; set; }

    private int initialTabIndex;
    private int cachedTabIndex;
    private string stackClass => StackIcons ? "mdc-tab--stacked" : "";
    private ElementReference elementReference;


    protected override void OnInitialized()
    {
        base.OnInitialized();

        SetParameters();
    }


    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        SetParameters();
    }


    private void SetParameters()
    {
        // Don't re-render unless the TabIndex has changed - probably not needed for tabs. Does cause issues if you
        // change stacked parameter or the tabs themselves - something you shouldn't do. Fix this in due course.
        if (TabIndex != cachedTabIndex)
        {
            initialTabIndex = TabIndex;
            cachedTabIndex = TabIndex;
        }
    }


    private async Task OnTabClickAsync(MdcTabContent content, int index)
    {
        if (index != cachedTabIndex)
        {
            string nextClass = "";

            if (index < cachedTabIndex)
            {
                nextClass = InFromLeft;
                ActiveTabContent.TabContentClass = OutToRight;
            }
            else
            {
                nextClass = InFromRight;
                ActiveTabContent.TabContentClass = OutToLeft;
            }

            await Task.Delay(100);

            content.TabContentClass = nextClass;
            ActiveTabContent = content;

            cachedTabIndex = index;
        }
    }


    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        @if (firstRender)
        {
            await jsRuntime.InvokeAsync<object>("BlazorMdc.tabBar.init", elementReference);
        }
    }


    private const string InFromLeft = "bmdc-slide-in-from-left";
    private const string InFromRight = "bmdc-slide-in-from-right";
    private const string OutToLeft = "bmdc-slide-out-to-left";
    private const string OutToRight = "bmdc-slide-out-to-right";


    internal MdcTabContent ActiveTabContent { get; set; }
    private List<MdcTabContent> tabContents = new List<MdcTabContent>();

    internal void AddTabContent(MdcTabContent tabContent)
    {
        tabContents.Add(tabContent);

        if (tabContents.Count == 1)
        {
            ActiveTabContent = tabContent;
        }

        StateHasChanged();
    }
}